@model SendNotificationViewModel

@{
    ViewBag.Title = "Send Notification";
    ViewBag.SubPageTitle = "Send Notification";
}

@section SubPageNavigation{
    <ul class="nav nav-pill">
        <li>
        @if (Model.NotificationTrackingViewModel.People.Count == 1)
        {
            var userId = Model.NotificationTrackingViewModel.People[0].User.Id;
            @Html.ActionLink("Back to Profile", "AdminEdit", "Person", new { id = userId, seminarId = Model.NotificationTrackingViewModel.Seminar.Id }, new { })
        }
        else
        { 
            @Html.ActionLink("Back to Seminar", "Details", "Seminar", new { id = Model.NotificationTrackingViewModel.Seminar.Id }, new { })
        }
        </li>
    </ul>
}

@section ScriptContent
{
    @Html.Partial("_NotificationScripts")

    <link href="@Url.Css("fileuploader.css")" type="text/css" rel="stylesheet"/>

    <script type="text/javascript" src='@Url.Script("tiny_mce/jquery.tinymce.js")'></script>
    <script type="text/javascript" src='@Url.Script("fileuploader.js")'></script>
    <script type="text/javascript">
        $(function () {
            $("#EmailQueue_Body").tinymce({
                script_url: '@Url.Script("tiny_mce/tiny_mce.js")',
                width: "500",
                height: "500",

                // General options
                theme: "advanced",
                //"pagebreak,style,layer,table,save,advhr,advimage,advlink,emotions,iespell,inlinepopups,insertdatetime,preview,media,searchreplace,print,contextmenu,paste,directionality,fullscreen,noneditable,visualchars,nonbreaking,xhtmlxtras,template",
                plugins: "spellchecker, paste",

                // Theme options
                theme_advanced_buttons1: "bold,italic,underline,|,bullist,numlist,|,search,replace,|,preview,|,forecolor,backcolor,|,pastetext,pasteword",
                theme_advanced_buttons2: "",
                theme_advanced_buttons3: "",
                theme_advanced_toolbar_location: "top",
                theme_advanced_toolbar_align: "left",
                theme_advanced_statusbar_location: "bottom",
                theme_advanced_resizing: false
            });

            $(".token").click(function () {
                var val = $(this).data("value");
                $('#EmailQueue_Body').tinymce().execCommand('mceInsertContent', false, val);
            });

            $("#NotificationTracking_NotificationType").change(function () {
                var typeId = $(this).val();
                var antiForgeryToken = $("input[name='__RequestVerificationToken']").val();
                var url = '@Url.Action("LoadTemplate", "Template")';

                $.post(url, { id: typeId, __RequestVerificationToken: antiForgeryToken }, function (result) {
                    if (result != "") {
                        $("#EmailQueue_Body").tinymce().execCommand('mceReplaceContent', false, result);
                    }
                });
            });

            // initiate the file upload
            var uploader = new qq.FileUploader({

                element: $("#file-uploader")[0],
                action: '@Url.Action("SaveAttachment")',
                onComplete: function (id, fileName, responseJSON) {

                    if (responseJSON != false) {

                        var result = [{ id: responseJSON.id}];
                        $("#attachment-template").tmpl(result).prependTo("#attachments");

                    }

                }

            });
        });       
    </script>
    
    <script type="text/x-jquery-tmpl" id="attachment-template">
    <input type='hidden' id='attachmentIds' name='attachmentIds' value='${id}' />
    </script>
}

@Html.ValidationSummary(false)

@using (Html.BeginForm("Send", "Notification", FormMethod.Post, new { @class = "form-horizontal" }))
{ 
    @Html.AntiForgeryToken()

    @Html.Partial("_NotificationTracking", Model.NotificationTrackingViewModel)
    
    <div class="control-group">
        <fieldset>
            <legend>Notification Message</legend>
            
            <div class="control-group">
                <label for="EmailQueue.FromAddress" class="control-label">From Address</label>
                <div class="controls">
                    <select id="EmailQueue.FromAddress" name="EmailQueue.FromAddress">
                        <option value="agribusiness@ucdavis.edu">agribusiness@ucdavis.edu</option>
                        <option value="dan.sumner@ucdavis.edu">dan.sumner@ucdavis.edu</option>
                    </select>
                    @Html.ValidationMessageFor(model => model.EmailQueue.FromAddress)
                </div>
            </div>
            <div class="control-group">
                <label for="EmailQueue.Subject" class="control-label">Subject</label>
                <div class="controls">
                    @Html.EditorFor(model => model.EmailQueue.Subject)
                    @Html.ValidationMessageFor(model => model.EmailQueue.Subject)
                </div>
            </div>
            <div class="control-group">
                <label for="Attachments" class="control-label">Attachment(s)</label>
                <div class="controls">
                    <div id="file-uploader"></div>
                </div>
            </div>
            <div class="control-group">
                <label for="EmailQueue.Body" class="control-label">
                    Body
                    @Html.ValidationMessageFor(model => model.EmailQueue.Body)
                </label>
                <div class="controls row-fluid">
                    <span class="span6">
                        @Html.EditorFor(model => model.EmailQueue.Body)
                    </span>
                    <span class="span2">
                        @Html.Partial("_TemplateTokens")                        
                    </span>
                    
                </div>
            </div>
        </fieldset>
    </div>

    <div class="form-actions">
        <input type="submit" class="btn btn-primary" value="Save" />
        @if (Model.NotificationTrackingViewModel.People.Count == 1)
        {
            var userId = Model.NotificationTrackingViewModel.People[0].User.Id;
            @Html.ActionLink("Cancel", "AdminEdit", "Person", new { id = userId, seminarId = Model.NotificationTrackingViewModel.Seminar.Id }, new { @class = "btn" })
        }
        else
        { 
            @Html.ActionLink("Cancel", "Details", "Seminar", new { id = Model.NotificationTrackingViewModel.Seminar.Id }, new { @class = "btn" })
        }
    </div>
}

